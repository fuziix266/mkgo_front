server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Habilitar compresión gzip para mejorar rendimiento
    gzip on;
    gzip_min_length 1000;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

    # Mime types adicionales por si acaso
    include /etc/nginx/mime.types;
    types {
        application/javascript dart;
    }

    # PROXY REVERSO AL BACKEND
    # Redirige todo lo que vaya a /api hacia el contenedor del backend
    location /api {
        # Nombre del servicio backend en la red de Docker (obtenido via SSH)
        proxy_pass http://mkgo-back-cx04m5:80;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Manejo de Single Page Application (Flutter)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Solución crítica para errores de Flutter Web:
    # Redirige la petición del archivo legacy 'AssetManifest.json' al nuevo 'AssetManifest.bin.json'
    # Esto evita que Flutter reciba HTML (404) cuando espera JSON, lo que causa los errores 'Uncaught Error'
    location = /assets/AssetManifest.json {
        try_files $uri /assets/AssetManifest.bin.json =404;
    }

    # Cacheo para assets y solucion al problema de AssetManifest
    location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|woff|woff2|ttf)$ {
        expires 1M;
        access_log off;
        add_header Cache-Control "public";
    }

    # Asegurar que los archivos JSON y BIN se sirvan correctamente
    location ~* \.(?:json|bin)$ {
        expires 1h;
        access_log off;
        add_header Cache-Control "public";
    }
}
